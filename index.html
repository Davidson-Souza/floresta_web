<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Floresta + Wasm demo</title>
  <script type="module">
    import init, { FlorestaChain } from './pkg/example_libfloresta.js';
    let florestaChain;

    async function sync(height) {
      const res = await fetch('https://api.dlsouza.lol/block/$'.replace("$", height), {
        mode: 'cors',
        method: 'GET',
        headers: {
          'Access-Control-Allow-Origin': '*'
        }
      });
      const block = await res.json();

      florestaChain.accept_block(JSON.stringify(block.data));
    }

    setInterval(() => {
      const paragaph = document.getElementById('height');
      paragaph.innerHTML = `Best block: ${florestaChain.tip} <br>
                            Height: ${florestaChain.height} <br>
                            network: ${florestaChain.network} <br>
                            ibd: ${florestaChain.ibd} <br>
                            difficulty: ${florestaChain.difficulty} <br>
                          `;
    }, 1000);

    (async function run() {
      await init();
      florestaChain = new FlorestaChain();

      for (let i = 1; i < 100; i++) {
        await sync(i);
      }
      florestaChain.toggle_ibd();
    })().catch(console.error);
  </script>
</head>

<body>
  <div id="content"
    style="display: block; align-self: center; max-width: 60%; position: absolute; left: 20%; top: 100px;">
    <p>
      This is a <a href="https://github.com/Davidson-Souza/floresta_web">demo</a> demo on how to use Floresta with
      WebAssembly. The module Floresta
      Chain is an export form the Rust library, generated with wasm-pack. You can create
      a new instance of Floresta Chain and call its methods from JavaScript. This is our
      representation of the Bitcoin Blockchain, it contains a chain of headers, the accumulator
      and some other information about the chain. This example will sync a few blocks from a remote
      api using <a href="https://github.com/Davidson-Souza/bridge">a REST API</a>.
    </p>
    <div id="height" style="position: relative;">Syncing...</p>
    </div>
</body>